<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата подписки</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6d28d9;
            --primary-light: #8b5cf6;
            --primary-hover: #5b21b6;
            --text: #1f2937;
            --text-light: #6b7280;
            --text-lighter: #9ca3af;
            --border: #e5e7eb;
            --background: #f9fafb;
            --card-bg: #ffffff;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --plus: #7c3aed;
            --success: #10b981;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
            color: var(--text);
            background-color: var(--background);
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            font-weight: 700;
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--text);
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .payment-card {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
            position: relative;
        }

        .popular-badge {
            position: absolute;
            top: 16px;
            right: -30px;
            background-color: var(--primary);
            color: white;
            padding: 4px 32px;
            font-size: 12px;
            font-weight: 600;
            transform: rotate(45deg);
            transform-origin: center;
            width: 120px;
            text-align: center;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .payment-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .payment-header p {
            color: var(--text-light);
            font-size: 16px;
        }

        .plan-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .plan-name {
            font-size: 18px;
            font-weight: 600;
        }

        .plan-name i {
            color: var(--primary);
            margin-right: 8px;
        }

        .plan-name.plus i {
            color: var(--plus);
        }

        .plan-price {
            font-size: 24px;
            font-weight: 700;
        }

        .plan-features {
            margin: 24px 0;
        }

        .plan-features li {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            font-size: 15px;
            color: var(--text);
            line-height: 1.5;
        }

        .plan-features li i {
            margin-right: 12px;
            color: var(--primary);
            font-size: 18px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .plus-features li i {
            color: var(--plus);
        }

        .total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-top: 1px solid var(--border);
            margin-top: 16px;
            font-weight: 600;
            font-size: 18px;
        }

        .discount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            color: var(--success);
            font-weight: 500;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 16px 24px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            border: none;
            gap: 8px;
            width: 100%;
            margin-top: 16px;
        }
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(109, 40, 217, 0.3), 0 2px 4px -1px rgba(109, 40, 217, 0.1);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(109, 40, 217, 0.3), 0 4px 6px -2px rgba(109, 40, 217, 0.1);
        }

        .btn-plus {
            background-color: var(--plus);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(124, 58, 237, 0.3), 0 2px 4px -1px rgba(124, 58, 237, 0.1);
        }

        .btn-plus:hover {
            background-color: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(124, 58, 237, 0.3), 0 4px 6px -2px rgba(124, 58, 237, 0.1);
        }

        .terms {
            display: flex;
            align-items: flex-start;
            margin: 24px 0;
        }

        .terms-checkbox {
            margin-right: 12px;
            margin-top: 4px;
        }

        .terms-text {
            font-size: 14px;
            color: var(--text-light);
        }

        .terms-text a {
            color: var(--primary);
            text-decoration: none;
        }

        .terms-text a:hover {
            text-decoration: underline;
        }

        .payment-method {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .payment-method p {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .payment-icon {
            font-size: 32px;
            color: var(--primary);
        }

        .back-link {
            text-align: center;
            padding-top: 24px;
        }

        .back-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .promo-code-container {
            margin: 16px 0;
            display: flex;
            gap: 8px;
        }

        .promo-code-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .promo-code-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.1);
        }

        .promo-code-btn {
            padding: 12px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .promo-code-btn:hover {
            background-color: var(--primary-hover);
        }

        .promo-code-btn:disabled {
            background-color: var(--text-lighter);
            cursor: not-allowed;
        }

        .error-message {
            color: var(--error);
            margin-top: 10px;
            font-size: 14px;
        }

        .success-message {
            color: var(--success);
            margin-top: 10px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .payment-card {
                padding: 24px;
            }

            .popular-badge {
                right: -34px;
                font-size: 11px;
                padding: 2px 28px;
                width: 110px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>Оплата подписки</h1>
        </div>

        <div class="payment-card" id="paymentCard">
            <div id="popularBadge" class="popular-badge" style="display: none;">Популярный</div>

            <div class="payment-header">
                <h2 id="planTitle">Premium подписка</h2>
                <p id="planPeriod">Ежемесячная оплата</p>
            </div>

            <div class="plan-details">
                <div class="plan-name" id="planName"><i class="fas fa-crown"></i> Premium</div>
                <div class="plan-price" id="planPrice">499 ₽</div>
            </div>

            <ul class="plan-features" id="planFeatures">
                <li><i class="fas fa-check-circle"></i> <strong>Все возможности Plus</strong></li>
                <li><i class="fas fa-check-circle"></i> До 15 профилей</li>
                <li><i class="fas fa-check-circle"></i> Расширенные настройки</li>
                <li><i class="fas fa-check-circle"></i> Эксклюзивные функции</li>
            </ul>

            <div class="promo-code-container">
                <input type="text" id="promoCodeInput" class="promo-code-input" placeholder="Введите промокод">
                <button id="applyPromoBtn" class="promo-code-btn">Применить</button>
            </div>
            <div id="promoMessage" class="error-message" style="display: none;"></div>

            <div id="discountContainer" class="discount" style="display: none;">
                <span>Скидка:</span>
                <span id="discountAmount">0 ₽</span>
            </div>

            <div class="total">
                <span>Итого к оплате:</span>
                <span id="totalPrice">499 ₽</span>
            </div>

            <div class="terms">
                <input type="checkbox" id="termsCheckbox" class="terms-checkbox" checked>
                <label for="termsCheckbox" class="terms-text">
                    Я согласен с <a href="#" target="_blank">условиями предоставления услуг</a> и <a href="#" target="_blank">политикой конфиденциальности</a>
                </label>
            </div>

            <button class="btn" id="payButton">
                <i class="fas fa-lock"></i> Оплатить подписку
            </button>
            <p class="error-message" id="planLevelError" style="display: none;">Вы не можете оплатить подписку уровня ниже Вашей</p>
        </div>

        <div class="back-link">
            <a href="/premium"><i class="fas fa-arrow-left"></i> Вернуться к выбору подписки</a>
        </div>
    </div>

    <script>
        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const planType = urlParams.get('plan') || 'premium_monthly';
        const user_id = localStorage.getItem('user_id');

        if (!user_id) {
            window.location.href = '/auth';
        }

        // Данные о планах
        const plans = {
            'plus_monthly': {
                name: 'Plus',
                title: 'Plus подписка',
                price: 199,
                period: 'Ежемесячная оплата',
                features: [
                    '<strong>Скрытие плашки "Фейк"</strong>',
                    'Добавление фото профиля',
                    'До 5 профилей',
                    'Базовые настройки приватности',
                    'Улучшенная поддержка'
                ],
                btnClass: 'btn-plus',
                icon: 'fas fa-bolt',
                plan: 'plus',
                time: 'month',
                popular: false
            },
            'plus_yearly': {
                name: 'Plus',
                title: 'Plus подписка',
                price: 1990,
                period: 'Годовая оплата (экономия 240 ₽)',
                features: [
                    '<strong>Скрытие плашки "Фейк"</strong>',
                    'Добавление фото профиля',
                    'До 5 профилей',
                    'Базовые настройки приватности',
                    'Улучшенная поддержка'
                ],
                btnClass: 'btn-plus',
                icon: 'fas fa-bolt',
                plan: 'plus',
                time: 'year',
                popular: false
            },
            'premium_monthly': {
                name: 'Premium',
                title: 'Premium подписка',
                price: 499,
                period: 'Ежемесячная оплата',
                features: [
                    '<strong>Все возможности Plus</strong>',
                    'До 15 профилей',
                    'Расширенные настройки',
                    'Эксклюзивные функции'
                ],
                btnClass: 'btn-primary',
                icon: 'fas fa-crown',
                plan: 'premium',
                time: 'month',
                popular: false
            },
            'premium_yearly': {
                name: 'Premium',
                title: 'Premium подписка',
                price: 4790,
                period: 'Годовая оплата (экономия 1 200 ₽)',
                features: [
                    '<strong>Все возможности Plus</strong>',
                    'До 15 профилей',
                    'Расширенные настройки',
                    'Эксклюзивные функции'
                ],
                btnClass: 'btn-primary',
                icon: 'fas fa-crown',
                plan: 'premium',
                time: 'year',
                popular: false
            },
            'plus_test': {
                name: 'Test',
                title: 'Test подписка',
                price: 2,
                period: 'Для тестирования',
                features: [
                    '<strong>Скрытие плашки "Фейк"</strong>',
                    'Добавление фото профиля',
                    'До 5 профилей',
                    'Базовые настройки приватности',
                    'Улучшенная поддержка'
                ],
                btnClass: 'btn-plus',
                icon: 'fas fa-dev',
                plan: 'plus',
                time: 'test',
                popular: false
            },
            'premium_test': {
                name: 'Test',
                title: 'Test подписка',
                price: 2,
                period: 'Для тестирования',
                features: [
                    '<strong>Все возможности Plus</strong>',
                    'До 15 профилей',
                    'Расширенные настройки',
                    'Эксклюзивные функции'
                ],
                btnClass: 'btn-primary',
                icon: 'fas fa-dev',
                plan: 'premium',
                time: 'test',
                popular: false
            }
        };

        // Текущий выбранный план
        let currentPlan = plans[planType];
        let discount = 0;
        let promoCode = '';
        let originalPrice = currentPlan.price;

        // Форматирование цены
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ₽';
        }

        async function checkPromoCode(code) {
    try {
        const response = await fetch('/api/check-promo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                promo_code: code,
                plan_type: currentPlan.plan,
                period: currentPlan.time
            })
        });

        const data = await response.json();

        if (response.ok) {
            if (data.valid) {
                // Рассчитываем сумму скидки в процентах
                const discountPercent = data.discount || 0;
                discount = Math.round(originalPrice * discountPercent / 100);
                promoCode = code;
                showPromoMessage(data.message || `Промокод успешно применен! Скидка ${discountPercent}%`, 'success');
                updateTotalPrice();
            } else {
                discount = 0;
                showPromoMessage(data.message || 'Промокод недействителен', 'error');
                updateTotalPrice();
            }
        } else {
            discount = 0;
            showPromoMessage(data.message || 'Ошибка при проверке промокода', 'error');
            updateTotalPrice();
        }
    } catch (error) {
        console.error('Ошибка при проверке промокода:', error);
        discount = 0;
        showPromoMessage('Ошибка соединения с сервером', 'error');
        updateTotalPrice();
    }
}

// Обновление итоговой цены
function updateTotalPrice() {
    const totalPrice = originalPrice - discount;
    document.getElementById('totalPrice').textContent = formatPrice(totalPrice);

    if (discount > 0) {
        document.getElementById('discountContainer').style.display = 'flex';
        // Показываем процент скидки
        const discountPercent = Math.round(discount / originalPrice * 100);
        document.getElementById('discountAmount').textContent = `-${discountPercent}% (${formatPrice(discount)})`;
    } else {
        document.getElementById('discountContainer').style.display = 'none';
    }
}

        // Показать сообщение о промокоде
        function showPromoMessage(message, type) {
            const promoMessage = document.getElementById('promoMessage');
            promoMessage.textContent = message;
            promoMessage.style.display = 'block';
            promoMessage.className = type === 'success' ? 'success-message' : 'error-message';

            // Скрыть сообщение через 5 секунд
            setTimeout(() => {
                promoMessage.style.display = 'none';
            }, 5000);
        }

        // Заполняем данные о плане
        function initPlan() {
            if (!currentPlan) return;

            document.getElementById('planTitle').textContent = currentPlan.title;
            document.getElementById('planPeriod').textContent = currentPlan.period;
            document.getElementById('planName').innerHTML = `<i class="${currentPlan.icon}"></i> ${currentPlan.name}`;
            document.getElementById('planPrice').textContent = formatPrice(currentPlan.price);
            document.getElementById('totalPrice').textContent = formatPrice(currentPlan.price);
            originalPrice = currentPlan.price;

            const featuresList = document.getElementById('planFeatures');
            featuresList.innerHTML = '';
            currentPlan.features.forEach(feature => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-check-circle"></i> ${feature}`;
                featuresList.appendChild(li);
            });

            const payButton = document.getElementById('payButton');
            payButton.className = `btn ${currentPlan.btnClass}`;
            payButton.innerHTML = `<i class="fas fa-lock"></i> Оплатить подписку`;

            if (currentPlan.popular) {
                document.getElementById('popularBadge').style.display = 'block';
            }
        }

        async function initiatePayment(currentPlan, callback) {
            try {
                const response = await fetch(`/payment/${currentPlan.plan}/${currentPlan.time}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        promo_code: promoCode || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${response.status}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    console.log('UUID транзакции:', data.uuid);
                    console.log('Переход на оплату:', data.url);
                    if (typeof callback === 'function') {
                        callback(data.url);
                    }
                } else {
                    console.error('Ошибка оплаты:', data);
                    showPromoMessage(data.message || 'Ошибка при создании платежа', 'error');
                }
            } catch (error) {
                console.error('Сбой запроса оплаты:', error.message);
                showPromoMessage('Ошибка соединения с сервером', 'error');
            }
        }

        async function getUserPlan() {
            try {
                const response = await fetch('/api/subscription', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.plan === "premium" && currentPlan.plan === "plus") {
                    document.getElementById('payButton').disabled = true;
                    document.getElementById("planLevelError").style.display = "block";
                }
            } catch (error) {
                console.error('Ошибка при получении данных подписки:', error);
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            initPlan();
            getUserPlan();

            // Обработчик кнопки применения промокода
            document.getElementById('applyPromoBtn').addEventListener('click', () => {
                const promoCode = document.getElementById('promoCodeInput').value.trim();
                if (promoCode) {
                    checkPromoCode(promoCode);
                } else {
                    showPromoMessage('Введите промокод', 'error');
                }
            });

            // Обработчик нажатия Enter в поле промокода
            document.getElementById('promoCodeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const promoCode = document.getElementById('promoCodeInput').value.trim();
                    if (promoCode) {
                        checkPromoCode(promoCode);
                    } else {
                        showPromoMessage('Введите промокод', 'error');
                    }
                }
            });

            // Обработчик кнопки оплаты
            document.getElementById('payButton').addEventListener('click', function() {
                const termsChecked = document.getElementById('termsCheckbox').checked;

                if (!termsChecked) {
                    showPromoMessage('Подтвердите согласие с условиями предоставления услуг', 'error');
                    return;
                }

                // Перенаправляем на страницу оплаты
                initiatePayment(currentPlan, function(paymentUrl) {
                    if (paymentUrl) {
                        window.location.href = paymentUrl;
                    }
                });
            });
        });
    </script>
</body>
</html>